<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive Folder Permissions Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background-color: #0056b3; }
        .success-btn { background-color: #28a745; }
        .success-btn:hover { background-color: #218838; }
        .warning-btn { background-color: #ffc107; color: #212529; }
        .warning-btn:hover { background-color: #e0a800; }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .folder-info {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .step {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Google Drive Folder Permissions Test</h1>
        
        <div id="status"></div>
        
        <h2>Current Folder Configuration</h2>
        <div class="folder-info">
            <strong>Folder ID:</strong> 1JcPf0LzShNZz1763I65KtFCP6HjJlGGR<br>
            <strong>Expected Location:</strong> Your Google Drive root or shared folder<br>
            <strong>Required Permissions:</strong> Apps Script must have access to this folder
        </div>
        
        <h2>Diagnosis Steps</h2>
        
        <div class="step">
            <h3>Step 1: Verify Folder Exists</h3>
            <p>Open your Google Drive and check if a folder with ID <code>1JcPf0LzShNZz1763I65KtFCP6HjJlGGR</code> exists.</p>
            <button onclick="testFolderAccess()">Test Folder Access</button>
        </div>
        
        <div class="step">
            <h3>Step 2: Check Folder Permissions</h3>
            <p>Make sure the folder is accessible by your Google account and Apps Script.</p>
            <button onclick="checkPermissions()">Check Permissions</button>
        </div>
        
        <div class="step">
            <h3>Step 3: Create New Folder (if needed)</h3>
            <p>If the folder doesn't exist or has permission issues, create a new one.</p>
            <button onclick="createNewFolder()" class="warning-btn">Create New Folder</button>
        </div>
        
        <div class="step">
            <h3>Step 4: Update Apps Script</h3>
            <p>Update your Apps Script with the correct folder ID.</p>
            <button onclick="updateAppsScript()" class="success-btn">Update Apps Script</button>
        </div>
        
        <h2>Test Results</h2>
        <pre id="log"></pre>
    </div>

    <script>
        const FOLDER_ID = '1JcPf0LzShNZz1763I65KtFCP6HjJlGGR';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzgLvYRn_H-0Z5uhSSF37sXhgVxNgYOutSJbXTETSnteG7ddSpL2KZX1ZMbalmISApI/exec';

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function testFolderAccess() {
            log('Testing folder access...');
            
            try {
                const testData = {
                    targetUrl: APPS_SCRIPT_URL,
                    action: 'test',
                    test: 'true',
                    driveFolderId: FOLDER_ID,
                    emailDestination: 'xavierfosso14@gmail.com'
                };
                
                const response = await fetch('http://localhost:8888/proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const responseText = await response.text();
                log(`Response status: ${response.status}`);
                log(`Response: ${responseText}`);
                
                if (response.ok) {
                    showStatus('‚úÖ Folder access test successful! The folder ID is working.', 'success');
                } else {
                    showStatus('‚ùå Folder access test failed. The folder ID may be incorrect.', 'error');
                }
                
            } catch (error) {
                log(`Error testing folder access: ${error.message}`);
                showStatus(`Error testing folder access: ${error.message}`, 'error');
            }
        }

        async function checkPermissions() {
            log('Checking folder permissions...');
            
            try {
                // Test with a simple upload attempt
                const testData = {
                    targetUrl: APPS_SCRIPT_URL,
                    action: 'upload',
                    driveFolderId: FOLDER_ID,
                    emailDestination: 'xavierfosso14@gmail.com',
                    zipFile: 'dGVzdA==', // base64 encoded "test"
                    sysZipFile: 'dGVzdA==',
                    timestamp: new Date().toISOString()
                };
                
                const response = await fetch('http://localhost:8888/proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const responseText = await response.text();
                log(`Upload test response: ${responseText}`);
                
                const responseData = JSON.parse(responseText);
                
                if (responseData.success) {
                    showStatus('‚úÖ Folder permissions are correct! Uploads should work.', 'success');
                } else if (responseData.message && responseData.message.includes('getFolderById')) {
                    showStatus('‚ùå Folder permissions issue detected. The folder ID may be incorrect or inaccessible.', 'error');
                } else {
                    showStatus('‚ö†Ô∏è Mixed results. Some operations work, others may fail.', 'warning');
                }
                
            } catch (error) {
                log(`Error checking permissions: ${error.message}`);
                showStatus(`Error checking permissions: ${error.message}`, 'error');
            }
        }

        function createNewFolder() {
            log('Creating new folder instructions...');
            
            const instructions = `
üìã Instructions to Create a New Google Drive Folder:

1. Go to Google Drive (drive.google.com)
2. Click "New" ‚Üí "Folder"
3. Name it "TechPlus POS Backups" or similar
4. Right-click the folder ‚Üí "Share"
5. Make sure it's accessible to your Google account
6. Copy the folder ID from the URL:
   - The URL will look like: https://drive.google.com/drive/folders/FOLDER_ID_HERE
   - Copy the FOLDER_ID_HERE part
7. Update your app configuration with the new folder ID
8. Update your Apps Script with the new folder ID

The folder ID is the long string in the URL after /folders/
            `;
            
            log(instructions);
            showStatus('üìã Instructions displayed in log. Follow them to create a new folder.', 'info');
        }

        function updateAppsScript() {
            log('Apps Script update instructions...');
            
            const instructions = `
üìã Instructions to Update Apps Script:

1. Go to Google Apps Script (script.google.com)
2. Open your backup handler script
3. Find this line:
   const DEFAULT_DRIVE_FOLDER_ID = '1JcPf0LzShNZz1763I65KtFCP6HjJlGGR';
4. Replace the folder ID with your new folder ID
5. Click "Deploy" ‚Üí "New deployment"
6. Choose "Web app"
7. Set access to "Anyone"
8. Click "Deploy"
9. Copy the new URL and update your app configuration

Make sure to update both the Apps Script AND your app configuration!
            `;
            
            log(instructions);
            showStatus('üìã Apps Script update instructions displayed in log.', 'info');
        }

        // Auto-test on page load
        window.onload = function() {
            log('Page loaded. Starting folder diagnostics...');
            testFolderAccess();
        };
    </script>
</body>
</html> 