<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Daily Report Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .error {
            color: red;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            background: #e6ffe6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Enhanced Daily Report Debug Test</h1>
        <p>This page tests the enhanced daily report generation to see what's happening.</p>
        
        <div>
            <button class="button" onclick="testEnhancedReport()">Test Enhanced Daily Report Generation</button>
            <button class="button" onclick="testOldReport()">Test Old Daily Report Generation</button>
            <button class="button" onclick="clearOutput()">Clear Output</button>
        </div>
        
        <div id="output"></div>
    </div>

    <script type="module">
        // Mock data for testing
        const mockData = {
            date: new Date().toISOString().split('T')[0],
            sales: [
                {
                    id: '1',
                    date: Date.now(),
                    total: 1500,
                    subtotal: 1400,
                    discount: 100,
                    taxAmount: 75,
                    paymentMethod: 'cash',
                    customerId: 'cust1',
                    items: [
                        { productId: 'prod1', productName: 'Product A', quantity: 2, price: 500, total: 1000 },
                        { productId: 'prod2', productName: 'Product B', quantity: 1, price: 500, total: 500 }
                    ]
                },
                {
                    id: '2',
                    date: Date.now(),
                    total: 2500,
                    subtotal: 2300,
                    discount: 200,
                    taxAmount: 125,
                    paymentMethod: 'card',
                    customerId: 'cust2',
                    items: [
                        { productId: 'prod3', productName: 'Product C', quantity: 1, price: 2500, total: 2500 }
                    ]
                }
            ],
            products: [
                { id: 'prod1', name: 'Product A', stock: 50, price: 500, minStock: 10 },
                { id: 'prod2', name: 'Product B', stock: 5, price: 500, minStock: 10 },
                { id: 'prod3', name: 'Product C', stock: 0, price: 2500, minStock: 5 },
                { id: 'prod4', name: 'Product D', stock: 100, price: 100, minStock: 20 }
            ],
            customers: [
                { id: 'cust1', name: 'Customer A', email: 'customer1@example.com' },
                { id: 'cust2', name: 'Customer B', email: 'customer2@example.com' }
            ],
            users: [
                { id: 'user1', name: 'Cashier 1', role: 'cashier' },
                { id: 'user2', name: 'Manager 1', role: 'manager' }
            ],
            settings: {
                storeName: 'Test Store',
                currency: 'XAF'
            }
        };

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            output.textContent += logEntry;
            console.log(logEntry);
        }

        function clearOutput() {
            document.getElementById('output').textContent = '';
        }

        async function testEnhancedReport() {
            log('Starting enhanced daily report test...');
            
            try {
                // Simulate the enhanced daily report generation
                const report = analyzeData(mockData);
                log('Enhanced report analysis completed successfully');
                log(`Total Revenue: $${report.totalRevenue.toFixed(2)}`);
                log(`Total Transactions: ${report.totalTransactions}`);
                log(`Alerts: ${report.alerts.length}`);
                log(`Predictions: ${report.predictions.length}`);
                
                // Generate PDF
                const pdfContent = await generatePDF(report, mockData);
                log(`PDF generated successfully, size: ${pdfContent.length} bytes`);
                
                // Create download
                const blob = new Blob([pdfContent], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `enhanced_daily_report_${mockData.date}.pdf`;
                a.click();
                URL.revokeObjectURL(url);
                
                log('Enhanced daily report downloaded successfully!', 'success');
                
            } catch (error) {
                log(`Error generating enhanced report: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        async function testOldReport() {
            log('Starting old daily report test...');
            
            try {
                // Simulate the old daily report generation
                const summary = generateOldSummary(mockData);
                log('Old report summary generated successfully');
                log(`Total Revenue: $${summary.totalRevenue.toLocaleString('en-US')} XAF`);
                log(`Total Transactions: ${summary.totalTransactions}`);
                
                log('Old daily report test completed!', 'success');
                
            } catch (error) {
                log(`Error generating old report: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        // Enhanced Daily Report Functions
        function analyzeData(data) {
            // üìà Sales & Revenue Analysis
            const totalRevenue = data.sales.reduce((sum, sale) => {
                const saleTotal = sale.total || 0;
                return sum + saleTotal;
            }, 0);
            const totalTransactions = data.sales.length;
            const averageTransactionValue = totalTransactions > 0 ? totalRevenue / totalTransactions : 0;
            
            // üí∏ Expenses & Cash Flow (estimated based on sales patterns)
            const totalExpenses = totalRevenue * 0.7; // Estimate 70% of revenue as expenses
            const netCashFlow = totalRevenue - totalExpenses;

            // üì¶ Inventory Analysis
            const lowStockItems = data.products.filter(p => (p.stock || 0) <= 10 && (p.stock || 0) > 0).length;
            const outOfStockItems = data.products.filter(p => (p.stock || 0) === 0).length;
            const inventoryValue = data.products.reduce((sum, p) => {
                const stock = p.stock || 0;
                const price = p.price || 0;
                return sum + (stock * price);
            }, 0);
            
            // üìä Operational Metrics
            const uniqueCustomers = new Set(data.sales.map(s => s.customerId).filter(Boolean));
            const totalCustomers = uniqueCustomers.size;
            const newCustomers = Math.floor(totalCustomers * 0.1); // Estimate 10% new customers
            const averageCustomerValue = totalCustomers > 0 ? totalRevenue / totalCustomers : 0;
            
            // üö® Alerts & Anomalies
            const alerts = [];
            
            if (outOfStockItems > 0) {
                alerts.push(`üö® Out of stock alert: ${outOfStockItems} items completely out of stock`);
            }
            
            if (lowStockItems > 0) {
                alerts.push(`‚ö†Ô∏è Low stock alert: ${lowStockItems} items need restocking`);
            }
            
            if (totalRevenue < 1000) {
                alerts.push(`üìâ Low revenue alert: Daily revenue below $1,000`);
            }
            
            if (netCashFlow < 0) {
                alerts.push(`üí∏ Negative cash flow alert: Net cash flow is negative`);
            }
            
            // üîÆ Predictive Insights
            const predictions = [];
            
            if (totalRevenue > 0) {
                predictions.push(`üìà Prediction: Tomorrow's revenue likely to be $${(totalRevenue * 0.9).toFixed(2)} - $${(totalRevenue * 1.1).toFixed(2)}`);
            }
            
            if (lowStockItems > 5) {
                predictions.push(`üì¶ Prediction: Need to reorder ${lowStockItems} items within 2-3 days`);
            }
            
            if (netCashFlow < 0) {
                predictions.push(`üí∞ Prediction: Cash flow may remain negative for next 2-3 days`);
            }
            
            if (averageTransactionValue > 50) {
                predictions.push(`üë• Prediction: High-value customers likely to return within 7 days`);
            }
            
            // üßæ Summary
            const highlights = [];
            
            if (totalRevenue > 5000) {
                highlights.push(`üéâ Excellent revenue performance: $${totalRevenue.toFixed(2)}`);
            }
            
            if (averageTransactionValue > 100) {
                highlights.push(`üíé High average transaction value: $${averageTransactionValue.toFixed(2)}`);
            }
            
            if (totalCustomers > 50) {
                highlights.push(`üë• Strong customer traffic: ${totalCustomers} unique customers`);
            }
            
            if (netCashFlow > 1000) {
                highlights.push(`üí∞ Positive cash flow: $${netCashFlow.toFixed(2)} net profit`);
            }
            
            const priorities = [];
            
            if (outOfStockItems > 0) {
                priorities.push(`üö® URGENT: Restock ${outOfStockItems} out-of-stock items`);
            }
            
            if (lowStockItems > 0) {
                priorities.push(`üì¶ HIGH: Reorder ${lowStockItems} low-stock items`);
            }
            
            if (netCashFlow < 0) {
                priorities.push(`üí∞ MEDIUM: Review expenses and optimize cash flow`);
            }
            
            if (totalTransactions < 20) {
                priorities.push(`üìä MEDIUM: Implement marketing strategies to increase foot traffic`);
            }

            return {
                totalRevenue,
                totalTransactions,
                averageTransactionValue,
                totalExpenses,
                netCashFlow,
                totalProducts: data.products.length,
                lowStockItems,
                outOfStockItems,
                inventoryValue,
                totalCustomers,
                newCustomers,
                averageCustomerValue,
                alerts,
                predictions,
                highlights,
                priorities,
                managerNotes: `Daily operations completed successfully. ${highlights.length} positive highlights noted. ${alerts.length} alerts require attention. Focus on ${priorities[0] || 'general operations'} for tomorrow.`
            };
        }

        async function generatePDF(report, data) {
            // Simulate PDF generation
            const pdfContent = new Uint8Array(1024); // Mock PDF content
            return pdfContent;
        }

        // Old Daily Report Functions
        function generateOldSummary(data) {
            const totalRevenue = data.sales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const totalTransactions = data.sales.length;
            const averageTransactionValue = totalTransactions > 0 ? totalRevenue / totalTransactions : 0;
            
            return {
                totalRevenue,
                totalTransactions,
                averageTransactionValue,
                date: data.date
            };
        }

        // Make functions globally available
        window.testEnhancedReport = testEnhancedReport;
        window.testOldReport = testOldReport;
        window.clearOutput = clearOutput;
    </script>
</body>
</html> 